<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lancer de Dés - Édition Or & Bleu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Base Styles from Galton Page --- */
        :root {
            --primary: #1a1a1a;
            --accent: #cfa346;
            --accent-text: #856404;
            --accent-light: #f4e8cb;
            --bg-color: #f8f9fa;
            --panel-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-color: #2d3436;
            --danger: #e74c3c;
            --highlight: #e74c3c;
            
            --color-m1: #c0392b;
            --color-m2: #2980b9;
            --color-m3: #27ae60;
            --color-m4: #8e44ad;
            --color-m5: #d35400;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: row;
            overflow: hidden; 
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: var(--bg-color);
            padding: 10px;
            overflow: hidden; 
            min-width: 0;
        }

        .game-container {
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            border: 4px solid var(--accent);
            background-color: var(--panel-bg);
            width: 95%;
            flex: 1;
            min-height: 0;
            max-height: 95vh;
            padding: 1rem;
        }

        .sidebar {
            width: 350px; /* Wider for tables */
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
            box-shadow: 5px 0 20px rgba(0,0,0,0.05);
            overflow-y: auto;
            z-index: 20;
            flex-shrink: 0;
        }

        .sidebar-header {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .control-group {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        select {
            background-color: var(--primary);
            color: white;
            border: 1px solid var(--primary);
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .action-btn-group button {
            background-color: var(--primary);
            color: white;
            border: 1px solid var(--primary);
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .btn-gold {
            background-color: var(--accent);
            color: var(--primary);
            transition: all 0.2s;
        }
        .btn-gold:hover { background-color: #cfa355; }
        .btn-gold:active { transform: translateY(1px); }

        .btn-reset {
            background-color: var(--primary);
            transition: all 0.2s;
        }
        .btn-reset:hover { background-color: #3d638a; }

        /* --- Custom Styles for Dice Page --- */
        .table-container {
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--panel-bg);
            max-height: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        thead {
            background: var(--primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 10px;
            color: var(--accent);
            font-weight: 600;
            border-bottom: 2px solid var(--accent);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        tr:nth-child(even) { background-color: var(--bg-color); }

        .sum-badge {
            display: inline-block;
            background: var(--accent);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
        }

        .dice-container {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .die {
            width: 20px; 
            height: 20px;
            background: white;
            border: 1px solid #94a3b8;
            border-radius: 3px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            padding: 2px;
            align-items: center;
            justify-items: center;
        }
        
        .dot {
            width: 4px;
            height: 4px;
            background-color: var(--primary);
            border-radius: 50%;
            opacity: 0;
        }

        .die[data-val="1"] .dot:nth-child(4) { opacity: 1; }
        .die[data-val="2"] .dot:nth-child(1), .die[data-val="2"] .dot:nth-child(7) { opacity: 1; }
        .die[data-val="3"] .dot:nth-child(1), .die[data-val="3"] .dot:nth-child(4), .die[data-val="3"] .dot:nth-child(7) { opacity: 1; }
        .die[data-val="4"] .dot:nth-child(1), .die[data-val="4"] .dot:nth-child(2), .die[data-val="4"] .dot:nth-child(6), .die[data-val="4"] .dot:nth-child(7) { opacity: 1; }
        .die[data-val="5"] .dot:nth-child(1), .die[data-val="5"] .dot:nth-child(2), .die[data-val="5"] .dot:nth-child(4), .die[data-val="5"] .dot:nth-child(6), .die[data-val="5"] .dot:nth-child(7) { opacity: 1; }
        .die[data-val="6"] .dot:nth-child(1), .die[data-val="6"] .dot:nth-child(2), .die[data-val="6"] .dot:nth-child(3), .die[data-val="6"] .dot:nth-child(5), .die[data-val="6"] .dot:nth-child(6), .die[data-val="6"] .dot:nth-child(7) { opacity: 1; }

    </style>
</head>
<body>

    <div class="sidebar">
        <a href="index.html" class="text-sm text-center block font-semibold text-[var(--accent-text)] hover:text-[#e0b050] transition-colors p-2 rounded-md hover:bg-gray-100">
            &larr; Retour à l'accueil
        </a>
        <div class="sidebar-header">
            <h2 class="text-lg font-bold text-[#1a1a1a]">Paramètres & Données</h2>
            <p class="text-xs text-[var(--accent-text)]">Contrôles et résultats en temps réel</p>
        </div>

        <div class="control-group">
            <label class="text-[11px] font-bold text-[#2d3436] uppercase tracking-wider">Nombre de dés</label>
            <select id="diceCount" onchange="resetSimulation()">
                <option value="1">1 Dé</option>
                <option value="2">2 Dés</option>
                <option value="3">3 Dés</option>
                <option value="4" selected>4 Dés</option>
                <option value="5">5 Dés</option>
            </select>
        </div>
        
        <div class="control-group">
            <label class="text-[11px] font-bold text-[#2d3436] uppercase tracking-wider">Actions</label>
            <div class="grid grid-cols-3 gap-2 action-btn-group">
                <button onclick="lancer(1)">+1</button>
                <button onclick="lancer(10)">+10</button>
                <button onclick="lancer(100)">+100</button>
            </div>
            <button class="btn-gold font-bold py-2 px-4 rounded shadow mt-2" onclick="lancer(1000)">Lancer 1000</button>
            <button class="btn-reset text-white text-sm font-bold py-2 px-4 rounded transition mt-1" onclick="resetSimulation()">♻ Réinitialiser</button>
        </div>

        <div class="bg-white p-3 rounded-lg border border-[#cfa346] text-center shadow-sm">
            <div class="flex justify-between text-sm">
                <span id="stat-rolls">Lancers: 0</span>
                <span id="stat-mean">Moyenne: 0.00</span>
            </div>
        </div>

        <div>
            <label class="text-[11px] font-bold text-[#2d3436] uppercase tracking-wider mb-2 block">Distribution des Sommes</label>
            <div class="table-container" style="max-height: 200px;">
                <table id="freqTable">
                    <thead><tr><th>Somme</th><th class="text-right">Qté</th><th class="text-right">Freq.</th></tr></thead>
                    <tbody id="freqBody"></tbody>
                </table>
            </div>
        </div>

        <div>
            <label class="text-[11px] font-bold text-[#2d3436] uppercase tracking-wider mb-2 block">Journal des Lancers</label>
            <div class="table-container" style="max-height: 250px;">
                <table id="logTable">
                    <thead><tr><th>#</th><th>Dés</th><th class="text-right">Total</th></tr></thead>
                    <tbody id="logBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="main-area">
        <div class="text-center mb-4">
            <h1 class="text-xl font-bold text-[var(--accent-text)] tracking-widest uppercase">Simulateur de Lancer de Dés</h1>
        </div>
        <div class="game-container">
            <canvas id="myCanvas"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');
        const MAX_LOG_SIZE = 100;

        // --- THEME COLORS ---
        const COLORS = {
            bg: '#ffffff',
            gold: '#cfa346',
            white: '#1a1a1a',
            accent: 'rgba(207, 163, 70, 0.7)', // Gold with alpha
            accentStroke: '#cfa346',
            text: '#2d3436',
            axis: '#e0e0e0'
        };

        let state = {
            counts: {},      
            totalRolls: 0,   
            nbDes: 4,        
            sumTotal: 0      
        };

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.closest('.game-container').getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // Use setTransform for safety
            if (state.totalRolls >= 0) draw();
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        function resetSimulation() {
            const select = document.getElementById('diceCount');
            state.nbDes = parseInt(select.value);
            state.counts = {};
            state.totalRolls = 0;
            state.sumTotal = 0;
            
            document.getElementById('logBody').innerHTML = '';
            
            const minSum = state.nbDes;
            const maxSum = state.nbDes * 6;
            for (let i = minSum; i <= maxSum; i++) {
                state.counts[i] = 0;
            }
            
            updateStats();
            draw();
        }

        function lancer(iterations) {
            for (let k = 0; k < iterations; k++) {
                let sum = 0;
                let diceResults = [];
                for (let i = 0; i < state.nbDes; i++) {
                    let val = Math.floor(Math.random() * 6) + 1;
                    sum += val;
                    diceResults.push(val);
                }
                state.counts[sum]++;
                state.totalRolls++;
                state.sumTotal += sum;
                if (iterations < 100) addLogEntry(state.totalRolls, diceResults, sum);
            }
            if (iterations >= 100) {
                 document.getElementById('logBody').innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-600">Log désactivé pour les lancers en masse.</td></tr>';
            }
            updateStats();
            draw();
        }

        function createDieVisual(value) {
            let dotsHTML = '';
            for(let i=0; i<7; i++) dotsHTML += '<div class="dot"></div>';
            return `<div class="die" data-val="${value}">${dotsHTML}</div>`;
        }

        function addLogEntry(id, diceResults, sum) {
            const logBody = document.getElementById('logBody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>#${id}</td>
                <td><div class="dice-container">${diceResults.map(createDieVisual).join('')}</div></td>
                <td class="text-right"><span class="sum-badge">${sum}</span></td>
            `;

            logBody.insertBefore(row, logBody.firstChild);
            if (logBody.children.length > MAX_LOG_SIZE) {
                logBody.removeChild(logBody.lastChild);
            }
        }

        function updateStats() {
            document.getElementById('stat-rolls').textContent = `Lancers: ${state.totalRolls.toLocaleString()}`;
            const mean = state.totalRolls > 0 ? (state.sumTotal / state.totalRolls).toFixed(2) : "0.00";
            document.getElementById('stat-mean').textContent = `Moyenne: ${mean}`;

            const freqBody = document.getElementById('freqBody');
            freqBody.innerHTML = '';
            const minSum = state.nbDes;
            const maxSum = state.nbDes * 6;

            for (let i = minSum; i <= maxSum; i++) {
                const count = state.counts[i] || 0;
                const percentage = state.totalRolls > 0 ? ((count / state.totalRolls) * 100).toFixed(1) : "0.0";
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-bold text-[#2d3436]">${i}</td>
                    <td class="text-right">${count.toLocaleString()}</td>
                    <td class="text-right text-gray-600">${percentage}%</td>
                `;
                freqBody.appendChild(row);
            }
        }

        function gaussian(x, mu, sigma) {
            const a = 1 / (sigma * Math.sqrt(2 * Math.PI));
            const b = -0.5 * Math.pow((x - mu) / sigma, 2);
            return a * Math.exp(b);
        }

        function draw() {
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;
            ctx.clearRect(0, 0, width, height);

            const padding = 30;
            const drawWidth = width - (padding * 2);
            const drawHeight = height - (padding * 2);
            
            const minSum = state.nbDes;
            const maxSum = state.nbDes * 6;
            const range = maxSum - minSum + 1;
            const barWidth = (drawWidth / range) * 0.85; 
            const stepX = drawWidth / range;

            let maxCount = 0;
            for (let c in state.counts) {
                if (state.counts[c] > maxCount) maxCount = state.counts[c];
            }

            const mu = state.nbDes * 3.5;
            const sigma = Math.sqrt(state.nbDes * (35/12));
            const peakProbability = gaussian(mu, mu, sigma);
            const theoreticalMaxCount = peakProbability * (state.totalRolls || 1); 
            
            let yMax = Math.max(maxCount, theoreticalMaxCount);
            if (yMax === 0) yMax = 10;
            yMax *= 1.15;

            // Histogram
            ctx.fillStyle = COLORS.accent;
            for (let i = minSum; i <= maxSum; i++) {
                const count = state.counts[i];
                const xPos = padding + ((i - minSum) * stepX) + (stepX - barWidth) / 2;
                const barH = (count / yMax) * drawHeight;
                const yPos = height - padding - barH;

                ctx.beginPath();
                ctx.roundRect(xPos, yPos, barWidth, barH, [3, 3, 0, 0]);
                ctx.fill();

                if (range <= 20 || (i % 2 === 0)) {
                    ctx.fillStyle = COLORS.text;
                    ctx.font = "11px sans-serif";
                    ctx.textAlign = "center";
                    ctx.fillText(i, xPos + barWidth/2, height - padding + 15);
                    ctx.fillStyle = COLORS.accent;
                }
            }

            // Gaussian Curve
            if (state.totalRolls > 1) {
                ctx.beginPath();
                ctx.lineWidth = 3;
                ctx.strokeStyle = COLORS.white;
                
                for (let j = 0; j <= 100; j++) {
                    const xVal = minSum + (j / 100) * (maxSum - minSum);
                    const prob = gaussian(xVal, mu, sigma);
                    const predictedCount = prob * state.totalRolls;
                    const yVal = height - padding - ((predictedCount / yMax) * drawHeight);
                    const xPixel = padding + ((xVal - minSum) * stepX) + stepX/2;

                    if (j === 0) ctx.moveTo(xPixel, yVal);
                    else ctx.lineTo(xPixel, yVal);
                }
                ctx.stroke();
            }

            // Axis line
            ctx.beginPath();
            ctx.strokeStyle = COLORS.axis;
            ctx.lineWidth = 1;
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
        }

        resetSimulation();
    </script>
</body>
</html>